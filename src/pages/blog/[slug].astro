---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { formatDate, getReadingTime, generateTableOfContents } from '../../utils/blog';
import type { BlogPost, TOCItem } from "../../utils/blog";

export const prerender = true;

// Build statique : fournir explicitement les chemins
export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// Props typées correctement
interface Props {
  post: BlogPost;
}

// Récupération des props fournies par getStaticPaths
const { post }: Props = Astro.props;
const { Content } = await post.render();

// Sécurise lecture/TOC si body absent
const body = post?.body ?? '';
const readingTime = getReadingTime(body);
const toc = generateTableOfContents(body);

// Dates en ISO (gère string ou Date)
const pub = post?.data?.pubDate
  ? new Date(post.data.pubDate)
  : new Date();
const publishedISO = pub.toISOString();

// Tags/image/auteur par défaut si manquants
const tags = Array.isArray(post?.data?.tags) ? post.data.tags : [];
const author = post?.data?.author ?? 'Régis Rolnin';
const image = post?.data?.image ?? '/images/regis.png';

// JSON-LD Schema
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post?.data?.title ?? "",
  "description": post?.data?.description ?? "",
  "image": image,
  "author": {
    "@type": "Person",
    "name": author,
    "url": "https://regisrolnin.com/a-propos"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Growth Expert",
    "logo": {
      "@type": "ImageObject",
      "url": "https://regisrolnin.com/images/regis.png"
    }
  },
  "datePublished": publishedISO,
  "dateModified": publishedISO,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://regisrolnin.com/blog/${post?.slug ?? ''}/`
  },
  "keywords": tags.join(", "),
  "articleSection": "Business Growth",
  "inLanguage": "fr-FR"
};
---

<Layout 
  title={`${post.data.title} - Growth Expert`}
  description={post.data.description}
  image={image}
  type="article"
>
  <!-- JSON-LD Schema -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(jsonLd)} />
  
  <!-- Article specific meta tags -->
  <meta property="article:published_time" content={publishedISO} slot="head" />
  <meta property="article:author" content={author} slot="head" />
  {tags.map((tag: string) => (
    <meta property="article:tag" content={tag} slot="head" />
  ))}

  <Header />
  
  <!-- Progress Bar -->
  <div id="reading-progress" class="fixed top-0 left-0 w-full h-1 bg-gray-200 z-50">
    <div class="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-300 ease-out" style="width: 0%"></div>
  </div>
  
  <main class="pt-20">
    <!-- Hero Section Amélioré -->
    <section class="py-16 lg:py-24 relative overflow-hidden bg-gradient-to-br from-gray-50 via-white to-blue-50">
      <!-- Background shapes -->
      <div class="absolute top-20 left-10 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl float-slow"></div>
      <div class="absolute bottom-20 right-10 w-80 h-80 bg-purple-500/5 rounded-full blur-3xl float-medium"></div>

      <div class="relative z-10 container mx-auto px-6">
        <div class="max-w-4xl mx-auto">
          <!-- Breadcrumb amélioré -->
          <nav class="mb-8 animate-fade-in">
            <ol class="flex items-center space-x-2 text-sm">
              <li>
                <a href="/" class="text-gray-500 hover:text-blue-600 transition-colors font-medium">
                  Accueil
                </a>
              </li>
              <li>
                <svg class="w-4 h-4 text-gray-400 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </li>
              <li>
                <a href="/blog" class="text-gray-500 hover:text-blue-600 transition-colors font-medium">
                  Blog
                </a>
              </li>
              <li>
                <svg class="w-4 h-4 text-gray-400 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </li>
              <li class="text-gray-700 font-medium truncate max-w-xs">{post.data.title}</li>
            </ol>
          </nav>

          <!-- Article Header Redesigné -->
          <header class="text-center mb-16 animate-fade-in" style="animation-delay: 0.1s;">
            <!-- Tags avec nouveau design -->
            <div class="flex flex-wrap justify-center gap-3 mb-8">
              {tags.map((tag: string, index: number) => (
                <span class={`inline-flex items-center px-4 py-2 text-sm font-semibold rounded-full transition-all duration-200 hover:scale-105 ${
                  index === 0 ? 'bg-blue-100 text-blue-700 border border-blue-200' : 
                  index === 1 ? 'bg-purple-100 text-purple-700 border border-purple-200' : 
                  'bg-emerald-100 text-emerald-700 border border-emerald-200'
                }`}>
                  <svg class="w-3 h-3 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                  </svg>
                  {tag}
                </span>
              ))}
            </div>

            <!-- Title avec meilleure hiérarchie -->
            <h1 class="text-3xl md:text-4xl lg:text-6xl font-bold text-navy-900 mb-8 font-crimson leading-tight max-w-4xl mx-auto">
              {post.data.title}
            </h1>

            <!-- Description mise en avant -->
            <p class="text-xl md:text-2xl text-gray-600 mb-10 font-crimson leading-relaxed max-w-3xl mx-auto">
              {post.data.description}
            </p>

            <!-- Meta Info redesignée -->
            <div class="flex flex-col sm:flex-row items-center justify-center gap-8 text-gray-600 mb-12">
              <div class="flex items-center bg-white rounded-full px-6 py-3 shadow-sm border border-gray-100">
                <a href="/a-propos" class="flex items-center group w-full">
                  <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3 group-hover:scale-105 transition-transform">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Auteur</p>
                    <p class="font-semibold font-crimson group-hover:text-blue-600 transition-colors">{author}</p>
                  </div>
                </a>
              </div>
              
              <div class="flex items-center bg-white rounded-full px-6 py-3 shadow-sm border border-gray-100">
                <div class="w-10 h-10 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-full flex items-center justify-center mr-3">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2z"></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Publié le</p>
                  <p class="font-semibold font-crimson">{formatDate(pub)}</p>
                </div>
              </div>
              
              <div class="flex items-center bg-white rounded-full px-6 py-3 shadow-sm border border-gray-100">
                <div class="w-10 h-10 bg-gradient-to-r from-amber-500 to-amber-600 rounded-full flex items-center justify-center mr-3">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Lecture</p>
                  <p class="font-semibold font-crimson">{readingTime} min</p>
                </div>
              </div>
            </div>

            <!-- Featured Image améliorée -->
            {image && (
              <div class="mb-8 animate-fade-in" style="animation-delay: 0.2s;">
                <div class="relative group">
                  <img 
                    src={image} 
                    alt={post.data.title}
                    class="w-full h-64 lg:h-96 object-cover rounded-3xl shadow-2xl transition-transform duration-500 group-hover:scale-[1.02]"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-3xl"></div>
                </div>
              </div>
            )}
          </header>
        </div>
      </div>
    </section>

    <!-- Main Content Section - 2 Colonnes -->
    <section class="py-16 lg:py-24 bg-white">
      <div class="container mx-auto px-6">
        <div class="max-w-7xl mx-auto">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-16">
            
            <!-- Sidebar Gauche (TOC + Social) -->
            <aside class="lg:col-span-1 order-2 lg:order-1">
              <div class="sticky top-32 space-y-8">
                
                <!-- Table of Contents Améliorée -->
                {toc.length > 0 && (
                  <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl shadow-lg border border-blue-100 p-8">
                    <div class="flex items-center mb-6">
                      <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                      </div>
                      <h3 class="text-lg font-bold text-navy-900 font-crimson">
                        Sommaire
                      </h3>
                    </div>
                    <nav class="toc">
                      <ul class="space-y-3">
                        {toc.map((item, index) => (
                          <li class={`toc-level-${item.level}`}>
                            <a 
                              href={`#${item.id}`}
                              class="group flex items-start text-sm text-gray-700 hover:text-blue-600 transition-all duration-200 py-2 px-3 rounded-lg hover:bg-white/80"
                              style={`margin-left: ${(item.level - 1) * 16}px`}
                            >
                              <span class="w-2 h-2 bg-blue-400 rounded-full mr-3 mt-2 flex-shrink-0 group-hover:bg-blue-600 transition-colors"></span>
                              <span class="font-crimson leading-relaxed">{item.text}</span>
                            </a>
                          </li>
                        ))}
                      </ul>
                    </nav>
                  </div>
                )}

                <!-- Social Share -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                  <h3 class="text-lg font-bold text-navy-900 mb-4 font-crimson">Partager</h3>
                  <div class="flex flex-col space-y-3">
                    <a href="#" class="flex items-center p-3 bg-sky-50 hover:bg-sky-100 rounded-xl transition-colors">
                      <svg class="w-5 h-5 text-sky-600 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M22.46 6c-.77.35-1.6.58-2.46.69a4.27 4.27 0 001.88-2.36 8.44 8.44 0 01-2.69 1.03 4.24 4.24 0 00-7.3 3.87A12.02 12.02 0 013 5.1a4.22 4.22 0 001.31 5.65A4.23 4.23 0 012.8 10v.05a4.25 4.25 0 003.4 4.17 4.3 4.3 0 01-1.91.07 4.26 4.26 0 003.97 2.95A8.5 8.5 0 012 19.54 12.02 12.02 0 008.29 21c7.55 0 11.68-6.26 11.68-11.68 0-.18 0-.36-.01-.54A8.3 8.3 0 0022.46 6z"/>
                      </svg>
                      <span class="text-sm font-medium">Twitter</span>
                    </a>
                    <a href="#" class="flex items-center p-3 bg-blue-50 hover:bg-blue-100 rounded-xl transition-colors">
                      <svg class="w-5 h-5 text-blue-600 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4.98 3.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5zM3 8.98h4v12H3v-12zM9 9h3.6v1.6h.1c.5-.9 1.7-1.8 3.4-1.8 3.7 0 4.4 2.4 4.4 5.6v6.6h-4v-5.9c0-1.4 0-3.2-2-3.2s-2.3 1.5-2.3 3.1v6h-4v-12z"/>
                      </svg>
                      <span class="text-sm font-medium">LinkedIn</span>
                    </a>
                  </div>
                </div>
              </div>
            </aside>

            <!-- Article Content Principal - 3 colonnes -->
            <article class="lg:col-span-3 order-1 lg:order-2">
              <div class="prose prose-xl max-w-none 
                           prose-headings:font-crimson prose-headings:text-navy-900 prose-headings:font-bold
                           prose-h1:text-4xl prose-h1:mb-8 prose-h1:mt-12 prose-h1:leading-tight
                           prose-h2:text-3xl prose-h2:mb-6 prose-h2:mt-10 prose-h2:leading-tight prose-h2:border-l-4 prose-h2:border-blue-500 prose-h2:pl-6 prose-h2:py-3
                           prose-h3:text-2xl prose-h3:mb-5 prose-h3:mt-8 prose-h3:leading-tight prose-h3:border-l-4 prose-h3:border-purple-500 prose-h3:pl-6 prose-h3:py-2
                           prose-h4:text-xl prose-h4:mb-4 prose-h4:mt-6 prose-h4:leading-tight prose-h4:text-emerald-700
                           prose-p:font-crimson prose-p:text-gray-700 prose-p:leading-relaxed prose-p:text-lg prose-p:mb-8 prose-p:text-justify
                           prose-strong:text-navy-900 prose-strong:font-semibold prose-strong:bg-yellow-100 prose-strong:px-1 prose-strong:rounded
                           prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline prose-a:font-medium
                           prose-li:font-crimson prose-li:text-gray-700 prose-li:mb-3 prose-li:leading-relaxed prose-li:text-lg
                           prose-ul:mb-8 prose-ol:mb-8 prose-ul:space-y-2 prose-ol:space-y-2
                           prose-blockquote:border-l-4 prose-blockquote:border-amber-400 prose-blockquote:bg-amber-50 prose-blockquote:p-8 prose-blockquote:rounded-r-xl prose-blockquote:my-8 prose-blockquote:font-crimson prose-blockquote:text-lg prose-blockquote:italic
                           prose-code:bg-gray-100 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-sm prose-code:font-mono">
                <Content />
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  // Reading Progress Bar
  function updateReadingProgress() {
    const article = document.querySelector('article');
    const progressBar = document.querySelector('#reading-progress div');
    
    if (!article || !progressBar || !(progressBar instanceof HTMLElement)) return;
    
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrollTop = window.scrollY;
    
    const progress = Math.min(
      Math.max((scrollTop - articleTop + windowHeight * 0.3) / articleHeight, 0),
      1
    );
    
    progressBar.style.width = `${progress * 100}%`;
  }
  
  // Smooth scroll for TOC links
  function handleTOCClick(event: Event) {
    const target = (event.target as Element).closest('a[href^="#"]') as HTMLAnchorElement;
    if (!target) return;
    
    event.preventDefault();
    const targetId = target.getAttribute('href')?.substring(1);
    if (!targetId) return;
    
    const targetElement = document.getElementById(targetId);
    
    if (targetElement) {
      const headerOffset = 120;
      const elementPosition = targetElement.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
      
      window.scrollTo({
        top: offsetPosition,
        behavior: 'smooth'
      });
      
      // Update active state in TOC
      document.querySelectorAll('.toc a').forEach(link => link.classList.remove('active'));
      target.classList.add('active');
    }
  }
  
  // Generate IDs for headings that don't have them
  function generateHeadingIds() {
    const headings = document.querySelectorAll('article h1, article h2, article h3, article h4, article h5, article h6');
    headings.forEach(heading => {
      if (!(heading as HTMLElement).id) {
        const text = heading.textContent || heading.innerHTML;
        const id = text
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '');
        (heading as HTMLElement).id = id;
      }
    });
  }
  
  // Event listeners
  window.addEventListener('scroll', updateReadingProgress);
  document.addEventListener('click', handleTOCClick);
  
  // Initialize on load
  document.addEventListener('DOMContentLoaded', () => {
    generateHeadingIds();
    updateReadingProgress();
  });
</script>

<style>
  /* Enhanced TOC Styles */
  .toc a {
    transition: all 0.2s ease;
  }
  
  .toc a:hover,
  .toc a.active {
    background-color: rgba(255, 255, 255, 0.9);
    transform: translateX(4px);
    color: #3b82f6 !important;
  }
  
  .toc a.active span {
    background-color: #3b82f6 !important;
  }
  
  /* Enhanced Prose Styles avec espacement amélioré */
  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    scroll-margin-top: 120px;
    position: relative;
  }
  
  .prose h2::before, .prose h3::before {
    content: '';
    position: absolute;
    left: -24px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 60%;
    border-radius: 2px;
  }
  
  .prose h2::before {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  }
  
  .prose h3::before {
    background: linear-gradient(135deg, #8b5cf6, #ec4899);
  }
  
  .prose blockquote {
    position: relative;
    margin: 3rem 0;
    font-style: italic;
  }
  
  .prose blockquote::before {
    content: '"';
    position: absolute;
    left: -15px;
    top: -15px;
    font-size: 4rem;
    color: #f59e0b;
    opacity: 0.3;
    font-family: serif;
    line-height: 1;
  }
  
  .prose ul li::marker {
    color: #3b82f6;
  }
  
  .prose ol li::marker {
    color: #8b5cf6;
    font-weight: bold;
  }
  
  /* Floating animations */
  .float-slow {
    animation: float-slow 8s ease-in-out infinite;
  }
  
  .float-medium {
    animation: float-medium 6s ease-in-out infinite;
  }
  
  @keyframes float-slow {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(2deg); }
  }
  
  @keyframes float-medium {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(-1deg); }
  }
  
  .animate-fade-in {
    animation: fadeIn 0.8s ease-out forwards;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>="flex items-center p-3 bg-blue-50 hover:bg-blue-100 rounded-xl transition-colors">
                      <svg class="w-5 h-5 text-blue-600 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/>
                      </svg>
                      <span class="text-sm font-medium">Facebook</span>
                    </a>
                    <a href="#" class