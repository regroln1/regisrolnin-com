---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ArticleBreadcrumb from '../../components/blog/ArticleBreadcrumb.astro';
import ArticleHeader from '../../components/blog/ArticleHeader.astro';
import ArticleSidebar from '../../components/blog/ArticleSidebar.astro';
import ArticleContent from '../../components/blog/ArticleContent.astro';
import ProgressBar from '../../components/blog/ProgressBar.astro';
import ArticleJsonLd from '../../components/blog/ArticleJsonLd.astro';
import ArticleScripts from '../../components/blog/ArticleScripts.astro';
import ArticleStyles from '../../components/blog/ArticleStyles.astro';
import AuthorBio from '../../components/blog/AuthorBio.astro';
import RelatedPosts from '../../components/blog/RelatedPosts.astro';
import Glossary from '../../components/blog/Glossary.astro';
import FAQ from '../../components/blog/FAQ.astro';
import { getReadingTime, generateTableOfContents } from '../../utils/blog';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post: CollectionEntry<'blog'>) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

// Récupération de tous les posts pour les articles similaires
const allPosts = await getCollection('blog');

// Calculs de base
const body = post?.body ?? '';
const readingTime = getReadingTime(body);
const toc = generateTableOfContents(body);

// Dates
const pub = post?.data?.pubDate ? new Date(post.data.pubDate) : new Date();
const publishedISO = pub.toISOString();

// Données de base
const tags = Array.isArray(post?.data?.tags) ? post.data.tags : [];
const author = post?.data?.author ?? 'Régis Rolnin';
const image = post?.data?.image ?? '/images/regis.png';

// Données optionnelles pour les nouveaux composants
const glossary = post?.data?.glossary ?? [];
const faq = post?.data?.faq ?? [];
const authorBio = post?.data?.authorBio;
const authorImage = post?.data?.authorImage;
const authorRole = post?.data?.authorRole;
const authorSocial = post?.data?.authorSocial;

// JSON-LD Schema
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post?.data?.title ?? "",
  "description": post?.data?.description ?? "",
  "image": image,
  "author": {
    "@type": "Person",
    "name": author,
    "url": "https://regisrolnin.com/a-propos"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Growth Expert",
    "logo": {
      "@type": "ImageObject",
      "url": "https://regisrolnin.com/images/regis.png"
    }
  },
  "datePublished": publishedISO,
  "dateModified": publishedISO,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://regisrolnin.com/blog/${post?.slug ?? ''}/`
  },
  "keywords": tags.join(", "),
  "articleSection": "Business Growth",
  "inLanguage": "fr-FR"
};
---

<Layout 
  title={`${post.data.title} - Growth Expert`}
  description={post.data.description}
  image={image}
  type="article"
>
  <ArticleJsonLd jsonLd={jsonLd} slot="head" />
  
  <!-- Article specific meta tags -->
  <meta property="article:published_time" content={publishedISO} slot="head" />
  <meta property="article:author" content={author} slot="head" />
  {tags.map((tag: string) => (
    <meta property="article:tag" content={tag} slot="head" />
  ))}

  <Header />
  <ProgressBar />
  
  <main class="pt-20">
    <!-- Hero Section -->
    <section class="py-16 lg:py-24 relative overflow-hidden bg-gradient-to-br from-gray-50 via-white to-blue-50">
      <!-- Background shapes -->
      <div class="absolute top-20 left-10 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl float-slow"></div>
      <div class="absolute bottom-20 right-10 w-80 h-80 bg-purple-500/5 rounded-full blur-3xl float-medium"></div>

      <div class="relative z-10 container mx-auto px-6">
        <div class="max-w-4xl mx-auto">
          <ArticleBreadcrumb title={post.data.title} />
          <ArticleHeader
            title={post.data.title}
            description={post.data.description}
            tags={tags}
            author={author}
            publishDate={pub}
            readingTime={readingTime}
            image={image}
          />
        </div>
      </div>
    </section>

    <!-- Main Content Section -->
    <section class="py-16 lg:py-24 bg-white">
      <div class="container mx-auto px-6">
        <div class="max-w-7xl mx-auto">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-16">
            <ArticleSidebar toc={toc} />
            
            <ArticleContent class="lg:col-span-3 order-1 lg:order-2">
              <Content />
            </ArticleContent>
          </div>
        </div>
      </div>
    </section>

    <!-- Glossary (si présent) -->
    {glossary.length > 0 && <Glossary terms={glossary} />}

    <!-- FAQ (si présent) -->
    {faq.length > 0 && <FAQ items={faq} />}

    <!-- Author Bio -->
    <AuthorBio 
      author={author}
      bio={authorBio}
      image={authorImage || image}
      role={authorRole}
      social={authorSocial}
    />

    <!-- Related Posts -->
    <RelatedPosts 
      currentSlug={post.slug}
      currentTags={tags}
      allPosts={allPosts}
      limit={3}
    />
  </main>

  <Footer />
  
  <ArticleScripts />
  <ArticleStyles />
</Layout>