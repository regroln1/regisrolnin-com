---
import type { CollectionEntry } from 'astro:content';
import { formatDate, getReadingTime } from '../../utils/blog';

interface Props {
  currentSlug: string;
  currentTags: string[];
  allPosts: CollectionEntry<'blog'>[];
  limit?: number;
  compact?: boolean;
}

const { currentSlug, currentTags, allPosts, limit = 3, compact = false } = Astro.props;

const currentPost = allPosts.find((p) => p.slug === currentSlug);
const manualSlugs = currentPost?.data?.relatedPosts || [];
const manualPosts = allPosts.filter((p) => manualSlugs.includes(p.slug));

const tagBasedPosts = allPosts
  .filter((post) => post.slug !== currentSlug && !manualPosts.includes(post))
  .map((post) => {
    const commonTags = (post.data.tags || []).filter((tag: string) => currentTags.includes(tag));
    return { post, score: commonTags.length };
  })
  .filter((item) => item.score > 0)
  .sort((a, b) => b.score - a.score)
  .map((item) => item.post);

// ✅ combine + remplissage si < limit
const combined = [...manualPosts, ...tagBasedPosts];
const fillers = combined.length < limit
  ? allPosts
      .filter((p) => p.slug !== currentSlug && !combined.includes(p))
      .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
      .slice(0, limit - combined.length)
  : [];

const finalPosts = [...combined, ...fillers].slice(0, limit);
---

{finalPosts.length > 0 && (
  <section class={compact ? "bg-white border border-gray-100 rounded-2xl p-5 shadow-sm" : "py-16 bg-gradient-to-br from-gray-50 to-blue-50"}>
    {!compact ? (
      <div class="container mx-auto px-6">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-navy-900 font-crimson mb-4">
              Articles recommandés
            </h2>
            <p class="text-lg text-gray-600 font-crimson">
              Continuez votre lecture avec ces contenus similaires
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {finalPosts.map((post) => {
              const readingTime = getReadingTime(post.body || '');
              const image = post.data.image || '/images/default-blog.jpg';
              const tags = post.data.tags || [];

              return (
                <article class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 group">
                  <a href={`/blog/${post.slug}`} class="block w-full">
                    <div class="relative h-48 overflow-hidden">
                      <img
                        src={image}
                        alt={post.data.title}
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                      />
                      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                      {tags[0] && (
                        <span class="absolute top-4 left-4 px-3 py-1 text-xs font-semibold bg-blue-600 text-white rounded-full">
                          {tags[0]}
                        </span>
                      )}
                    </div>
                    <div class="p-6">
                      <h3 class="text-xl font-bold text-navy-900 font-crimson mb-3 line-clamp-2 group-hover:text-blue-600 transition-colors">
                        {post.data.title}
                      </h3>
                      <p class="text-gray-600 font-crimson mb-4 line-clamp-3">
                        {post.data.description}
                      </p>
                      <div class="flex items-center justify-between text-sm text-gray-500 pt-4 border-t border-gray-100">
                        <div class="flex items-center">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2z"></path>
                          </svg>
                          <span>{formatDate(new Date(post.data.pubDate))}</span>
                        </div>
                        <div class="flex items-center">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          <span>{readingTime} min</span>
                        </div>
                      </div>
                    </div>
                  </a>
                </article>
              );
            })}
          </div>

          <div class="text-center mt-12">
            <a
              href="/blog"
              class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-full hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl"
            >
              Voir tous les articles
              <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
    ) : (
      <div class="space-y-6">
        {finalPosts.map((post) => {
          const readingTime = getReadingTime(post.body || '');
          const image = post.data.image || '/images/default-blog.jpg';
          return (
            <article class="flex items-start gap-4 group">
              <img src={image} alt={post.data.title} class="w-24 h-24 object-cover rounded-xl flex-shrink-0 border border-gray-100" />
              <div class="flex-1">
                <h3 class="text-sm font-semibold text-gray-800 mb-1 group-hover:text-blue-600 transition-colors line-clamp-2">
                  {post.data.title}
                </h3>
                <p class="text-xs text-gray-500 mb-2 line-clamp-2">{post.data.description}</p>
                <p class="text-[11px] text-gray-400">{formatDate(new Date(post.data.pubDate))}</p>
              </div>
            </article>
          );
        })}
      </div>
    )}
  </section>
)}
